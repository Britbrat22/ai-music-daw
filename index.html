<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Music Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #0a0a0a; color: #e5e5e5; overflow: hidden; margin: 0; }
        .step-btn { width: 32px; height: 32px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; cursor: pointer; transition: all 0.1s; }
        .step-btn:hover { background: rgba(255,255,255,0.2); }
        .step-btn.active { background: #00d4ff; box-shadow: 0 0 10px rgba(0,212,255,0.5); }
        .step-btn.playing { transform: scale(1.1); border-color: white; }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: #00d4ff; cursor: pointer; }
        .clip { position: absolute; height: 80%; background: linear-gradient(135deg, #00d4ff, #b24bf3); border-radius: 4px; cursor: move; display: flex; align-items: center; padding: 0 8px; font-size: 11px; font-weight: 500; box-shadow: 0 2px 8px rgba(0,0,0,0.5); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 50; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .meter-bar { transition: height 0.05s ease; }
    </style>
</head>
<body style="height: 100vh; display: flex; flex-direction: column;">

    <!-- Header -->
    <header style="height: 56px; background: #111; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #9333ea, #06b6d4); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-music" style="color: white; font-size: 14px;"></i>
            </div>
            <div>
                <h1 style="margin: 0; font-size: 14px; font-weight: bold;">StudioAI</h1>
                <p style="margin: 0; font-size: 10px; color: #666;">Web Audio DAW</p>
            </div>
        </div>

        <div style="display: flex; align-items: center; gap: 12px; background: #1a1a1a; padding: 4px 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
            <button id="stopBtn" style="background: none; border: none; color: #999; cursor: pointer; padding: 8px;">
                <i class="fas fa-square"></i>
            </button>
            <button id="playBtn" style="width: 40px; height: 40px; background: #06b6d4; border: none; border-radius: 50%; color: black; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-play" id="playIcon" style="margin-left: 3px;"></i>
            </button>
            <div style="width: 1px; height: 24px; background: rgba(255,255,255,0.1); margin: 0 8px;"></div>
            <span id="timeDisplay" style="font-family: monospace; color: #06b6d4; font-size: 18px; min-width: 60px; text-align: center;">00:00</span>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 10px; color: #666; text-transform: uppercase;">BPM</span>
                <input type="number" id="bpmInput" value="128" min="60" max="200" style="width: 50px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); color: white; padding: 4px; border-radius: 4px; text-align: center; font-size: 12px;">
            </div>
        </div>

        <div style="display: flex; gap: 8px;">
            <button onclick="exportWAV()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                <i class="fas fa-download"></i> Export
            </button>
            <button onclick="openModal()" style="background: #9333ea; border: none; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-wand-magic-sparkles"></i> Generate
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div style="flex: 1; display: flex; overflow: hidden;">
        
        <!-- Sidebar -->
        <aside style="width: 250px; background: #111; border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; padding: 16px; gap: 16px; overflow-y: auto;">
            <div>
                <h3 style="font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.05em;">Instruments</h3>
                <button onclick="setInst('drums')" id="btn-drums" style="width: 100%; text-align: left; padding: 10px; background: rgba(6,182,212,0.2); border: 1px solid rgba(6,182,212,0.3); color: #06b6d4; border-radius: 6px; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <i class="fas fa-drum" style="margin-right: 8px;"></i> Drum Machine
                </button>
                <button onclick="setInst('bass')" id="btn-bass" style="width: 100%; text-align: left; padding: 10px; background: transparent; border: 1px solid rgba(255,255,255,0.1); color: #999; border-radius: 6px; margin-bottom: 6px; cursor: pointer; font-size: 13px;">
                    <i class="fas fa-guitar" style="margin-right: 8px;"></i> Bass Synth
                </button>
                <button onclick="setInst('lead')" id="btn-lead" style="width: 100%; text-align: left; padding: 10px; background: transparent; border: 1px solid rgba(255,255,255,0.1); color: #999; border-radius: 6px; cursor: pointer; font-size: 13px;">
                    <i class="fas fa-wave-square" style="margin-right: 8px;"></i> Lead Synth
                </button>
            </div>

            <div>
                <h3 style="font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.05em;">Effects</h3>
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-bottom: 4px;">
                        <span>Reverb</span>
                        <span>30%</span>
                    </div>
                    <input type="range" min="0" max="100" value="30" oninput="if(window.instruments && instruments.reverb) instruments.reverb.wet.value = this.value/100">
                </div>
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-bottom: 4px;">
                        <span>Master Vol</span>
                    </div>
                    <input type="range" min="0" max="100" value="80" oninput="if(Tone && Tone.Destination) Tone.Destination.volume.value = (this.value/100)*20 - 20">
                </div>
                <div style="background: #1a1a1a; border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; margin-top: 16px;">
                    <div style="font-size: 10px; color: #666; margin-bottom: 8px;">Master Meter</div>
                    <div style="display: flex; gap: 4px; height: 60px; align-items: end;" id="meters">
                        <div class="meter-bar" style="flex: 1; background: #22c55e; height: 20%; border-radius: 2px;"></div>
                        <div class="meter-bar" style="flex: 1; background: #22c55e; height: 35%; border-radius: 2px;"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Center -->
        <main style="flex: 1; display: flex; flex-direction: column; background: #0a0a0a;">
            
            <!-- Timeline -->
            <div style="height: 32px; background: #151515; border-bottom: 1px solid rgba(255,255,255,0.1); position: relative;">
                <div id="playhead" style="position: absolute; top: 0; bottom: 0; width: 2px; background: #06b6d4; left: 0%; pointer-events: none; z-index: 20;">
                    <div style="width: 10px; height: 10px; background: #06b6d4; transform: translateX(-50%) rotate(45deg); position: absolute; top: -5px; left: 50%;"></div>
                </div>
            </div>

            <!-- Tracks -->
            <div style="flex: 1; overflow-y: auto; padding: 16px;">
                <div style="background-image: linear-gradient(to right, #1a1a1a 1px, transparent 1px); background-size: 40px 100%;">
                    
                    <!-- Track 1 -->
                    <div style="height: 80px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 8px; position: relative;">
                        <div style="position: absolute; left: 0; width: 120px; height: 100%; background: #111; border-right: 1px solid rgba(255,255,255,0.1); padding: 8px;">
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <button style="width: 20px; height: 20px; background: rgba(239,68,68,0.2); color: #ef4444; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">M</button>
                                <span style="font-size: 12px; color: #ccc;">Drums</span>
                            </div>
                        </div>
                        <div style="margin-left: 120px; height: 100%; position: relative;" id="track-drums">
                            <div class="clip" style="left: 10px; width: 160px;" onmousedown="startDrag(event, this)">
                                <i class="fas fa-drum" style="margin-right: 6px;"></i> Pattern A
                            </div>
                        </div>
                    </div>

                    <!-- Track 2 -->
                    <div style="height: 80px; border-bottom: 1px solid rgba(255,255,255,0.05); position: relative;">
                        <div style="position: absolute; left: 0; width: 120px; height: 100%; background: #111; border-right: 1px solid rgba(255,255,255,0.1); padding: 8px;">
                            <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                                <button style="width: 20px; height: 20px; background: rgba(239,68,68,0.2); color: #ef4444; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">M</button>
                                <span style="font-size: 12px; color: #ccc;">Bass</span>
                            </div>
                        </div>
                        <div style="margin-left: 120px; height: 100%; position: relative;" id="track-bass"></div>
                    </div>
                </div>
            </div>

            <!-- Sequencer -->
            <div style="height: 200px; background: #111; border-top: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <span style="font-size: 12px; font-weight: 600;">Step Sequencer (16 Steps)</span>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="clearSeq()" style="background: rgba(255,255,255,0.05); border: none; color: #999; padding: 4px 12px; border-radius: 4px; font-size: 11px; cursor: pointer;">Clear</button>
                        <button onclick="randomSeq()" style="background: rgba(255,255,255,0.05); border: none; color: #999; padding: 4px 12px; border-radius: 4px; font-size: 11px; cursor: pointer;">Random</button>
                    </div>
                </div>
                <div style="flex: 1; padding: 16px; overflow-x: auto;" id="sequencer-container">
                    <!-- Generated by JS -->
                </div>
            </div>
        </main>
    </div>

    <!-- AI Modal -->
    <div id="aiModal" class="modal">
        <div style="background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px; width: 320px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #9333ea, #06b6d4); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite;">
                    <i class="fas fa-robot" style="color: white;"></i>
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 16px; font-weight: bold;">AI Generator</h3>
                    <p style="margin: 0; font-size: 11px; color: #666;">Procedural Pattern Synthesis</p>
                </div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 11px; color: #666; margin-bottom: 4px; text-transform: uppercase;">Genre</label>
                <select id="genreSelect" style="width: 100%; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); color: white; padding: 8px; border-radius: 6px; font-size: 13px;">
                    <option value="techno">Techno</option>
                    <option value="house">House</option>
                    <option value="hiphop">Hip Hop</option>
                    <option value="trap">Trap</option>
                </select>
            </div>

            <button onclick="generate()" id="genBtn" style="width: 100%; background: linear-gradient(135deg, #9333ea, #06b6d4); border: none; color: white; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                Generate Pattern
            </button>

            <div id="progress" style="display: none; margin-top: 16px;">
                <div style="height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-bottom: 8px;">
                    <div id="progBar" style="height: 100%; width: 0%; background: linear-gradient(to right, #9333ea, #06b6d4); transition: width 0.3s;"></div>
                </div>
                <div style="text-align: center; font-size: 11px; color: #666;" id="progText"></div>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>

    <script>
        // State
        let isPlaying = false;
        let currentStep = 0;
        let currentInst = 'drums';
        let instruments = {};
        let patterns = { drums: [[],[],[],[]], bass: [[],[],[],[]], lead: [[],[],[],[]] };
        let recorder = null;
        
        // Initialize patterns
        for(let i=0; i<4; i++) {
            for(let j=0; j<16; j++) patterns.drums[i][j] = false;
            for(let j=0; j<16; j++) patterns.bass[i][j] = false;
            for(let j=0; j<16; j++) patterns.lead[i][j] = false;
        }

        // Audio Init
        async function initAudio() {
            await Tone.start();
            
            // Drums
            const kick = new Tone.MembraneSynth().toDestination();
            const snare = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { decay: 0.1 } }).toDestination();
            const hihat = new Tone.MetalSynth({ envelope: { decay: 0.05 } }).toDestination();
            hihat.volume.value = -10;
            
            instruments.drums = [kick, snare, hihat];
            
            // Bass
            instruments.bass = new Tone.MonoSynth({
                oscillator: { type: "sawtooth" },
                filterEnvelope: { baseFrequency: 200 }
            }).toDestination();
            
            // Lead
            instruments.lead = new Tone.PolySynth(Tone.Synth).toDestination();
            
            // Effects
            instruments.reverb = new Tone.Reverb(2).toDestination();
            instruments.drums[0].connect(instruments.reverb);
            instruments.bass.connect(instruments.reverb);
            
            // Transport
            Tone.Transport.scheduleRepeat((time) => {
                step(time);
            }, "16n");
            
            // Setup recorder
            const dest = Tone.Destination;
            if(dest && dest.context && dest.context.createMediaStreamDestination) {
                const streamDest = dest.context.createMediaStreamDestination();
                dest.connect(streamDest);
                recorder = new MediaRecorder(streamDest.stream);
                const chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/wav' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'studio_export_' + Date.now() + '.wav';
                    a.click();
                };
            }
            
            updateSequencer();
            animateMeters();
        }

        function step(time) {
            currentStep = (currentStep + 1) % 16;
            
            // Update playhead
            document.getElementById('playhead').style.left = (currentStep / 16 * 100) + '%';
            document.getElementById('timeDisplay').textContent = 
                '00:' + (currentStep < 10 ? '0'+currentStep : currentStep);
            
            // Play sounds
            if(patterns.drums[0][currentStep]) instruments.drums[0].triggerAttackRelease("C1", "8n", time);
            if(patterns.drums[1][currentStep]) instruments.drums[1].triggerAttackRelease("8n", time);
            if(patterns.drums[2][currentStep]) instruments.drums[2].triggerAttackRelease("32n", time);
            
            if(patterns.bass[0][currentStep]) instruments.bass.triggerAttackRelease("C2", "16n", time);
            if(patterns.bass[1][currentStep]) instruments.bass.triggerAttackRelease("E2", "16n", time);
            
            // Visual
            document.querySelectorAll('.step-btn').forEach((btn, idx) => {
                const step = idx % 16;
                if(step === currentStep) {
                    btn.style.borderColor = 'white';
                    btn.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        btn.style.borderColor = '';
                        btn.style.transform = '';
                    }, 100);
                }
            });
        }

        // Controls
        document.getElementById('playBtn').onclick = async function() {
            if(!instruments.drums) await initAudio();
            
            if(isPlaying) {
                Tone.Transport.pause();
                isPlaying = false;
                this.style.background = '#06b6d4';
                document.getElementById('playIcon').className = 'fas fa-play';
            } else {
                Tone.Transport.start();
                isPlaying = true;
                this.style.background = '#22c55e';
                document.getElementById('playIcon').className = 'fas fa-pause';
            }
        };

        document.getElementById('stopBtn').onclick = function() {
            Tone.Transport.stop();
            currentStep = 0;
            isPlaying = false;
            document.getElementById('playhead').style.left = '0%';
            document.getElementById('playBtn').style.background = '#06b6d4';
            document.getElementById('playIcon').className = 'fas fa-play';
        };

        document.getElementById('bpmInput').onchange = function() {
            Tone.Transport.bpm.value = this.value;
        };

        // Sequencer UI
        function updateSequencer() {
            const container = document.getElementById('sequencer-container');
            container.innerHTML = '';
            
            const labels = currentInst === 'drums' ? ['Kick', 'Snare', 'Hi-Hat'] : 
                          currentInst === 'bass' ? ['C', 'E', 'G'] : ['Note 1', 'Note 2', 'Note 3'];
            
            for(let row=0; row<3; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.style.display = 'flex';
                rowDiv.style.gap = '4px';
                rowDiv.style.marginBottom = '8px';
                rowDiv.style.alignItems = 'center';
                
                const label = document.createElement('div');
                label.style.width = '50px';
                label.style.fontSize = '11px';
                label.style.color = '#666';
                label.textContent = labels[row];
                rowDiv.appendChild(label);
                
                for(let step=0; step<16; step++) {
                    const btn = document.createElement('div');
                    btn.className = 'step-btn';
                    if(patterns[currentInst][row][step]) btn.classList.add('active');
                    btn.onclick = () => {
                        patterns[currentInst][row][step] = !patterns[currentInst][row][step];
                        updateSequencer();
                    };
                    rowDiv.appendChild(btn);
                }
                container.appendChild(rowDiv);
            }
        }

        function setInst(inst) {
            currentInst = inst;
            ['drums','bass','lead'].forEach(i => {
                const btn = document.getElementById('btn-'+i);
                if(i === inst) {
                    btn.style.background = 'rgba(6,182,212,0.2)';
                    btn.style.borderColor = 'rgba(6,182,212,0.3)';
                    btn.style.color = '#06b6d4';
                } else {
                    btn.style.background = 'transparent';
                    btn.style.borderColor = 'rgba(255,255,255,0.1)';
                    btn.style.color = '#999';
                }
            });
            updateSequencer();
        }

        function clearSeq() {
            for(let i=0; i<4; i++) {
                for(let j=0; j<16; j++) patterns[currentInst][i][j] = false;
            }
            updateSequencer();
        }

        function randomSeq() {
            for(let i=0; i<4; i++) {
                for(let j=0; j<16; j++) patterns[currentInst][i][j] = Math.random() > 0.7;
            }
            updateSequencer();
        }

        // AI Modal
        function openModal() {
            document.getElementById('aiModal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('aiModal').classList.remove('show');
        }

        function generate() {
            const btn = document.getElementById('genBtn');
            const prog = document.getElementById('progress');
            const bar = document.getElementById('progBar');
            const text = document.getElementById('progText');
            const genre = document.getElementById('genreSelect').value;
            
            btn.disabled = true;
            prog.style.display = 'block';
            
            const steps = ['Analyzing...', 'Synthesizing...', 'Optimizing...', 'Done!'];
            let i = 0;
            
            const interval = setInterval(() => {
                bar.style.width = ((i+1)/4*100) + '%';
                text.textContent = steps[i];
                i++;
                if(i >= 4) {
                    clearInterval(interval);
                    setTimeout(() => {
                        applyPattern(genre);
                        closeModal();
                        btn.disabled = false;
                        prog.style.display = 'none';
                        bar.style.width = '0%';
                    }, 500);
                }
            }, 400);
        }

        function applyPattern(genre) {
            clearSeq();
            if(genre === 'techno') {
                for(let i=0; i<16; i++) {
                    if(i%4===0) patterns.drums[0][i] = true; // Kick
                    if(i%4===2) patterns.drums[1][i] = true; // Snare
                    if(i%2===0) patterns.drums[2][i] = true; // Hats
                }
            } else if(genre === 'hiphop') {
                [0,4,8,12].forEach(i => patterns.drums[0][i] = true); // Kick
                [4,12].forEach(i => patterns.drums[1][i] = true); // Snare
                [2,6,10,14].forEach(i => patterns.drums[2][i] = true); // Hats
            } else {
                randomSeq();
            }
            updateSequencer();
        }

        // Close modal on outside click
        document.getElementById('aiModal').onclick = function(e) {
            if(e.target === this) closeModal();
        };

        // Meters
        function animateMeters() {
            const bars = document.querySelectorAll('.meter-bar');
            bars.forEach(bar => {
                const h = Math.random() * 100;
                bar.style.height = h + '%';
                bar.style.background = h > 80 ? '#ef4444' : h > 50 ? '#eab308' : '#22c55e';
            });
            requestAnimationFrame(animateMeters);
        }

        // Export
        function exportWAV() {
            if(!recorder) return alert('Audio not initialized. Click Play first.');
            if(recorder.state === 'inactive') {
                recorder.start();
                if(!isPlaying) document.getElementById('playBtn').click();
                setTimeout(() => {
                    recorder.stop();
                    alert('Download started!');
                }, 3000);
            }
        }

        // Drag and drop
        let dragged = null;
        let dragOffset = {x:0,y:0};

        function startDrag(e, el) {
            dragged = el;
            dragOffset.x = e.clientX - el.offsetLeft;
            dragOffset.y = e.clientY - el.offsetTop;
            el.style.zIndex = 1000;
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
        }

        function onDrag(e) {
            if(!dragged) return;
            dragged.style.left = (e.clientX - dragOffset.x) + 'px';
            dragged.style.top = (e.clientY - dragOffset.y) + 'px';
        }

        function endDrag() {
            if(dragged) dragged.style.zIndex = '';
            dragged = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);
        }

        // Keyboard
        document.onkeydown = (e) => {
            if(e.code === 'Space') {
                e.preventDefault();
                document.getElementById('playBtn').click();
            }
        };

        // Default pattern
        patterns.drums[0][0] = true;
        patterns.drums[0][8] = true;
        patterns.drums[1][4] = true;
        patterns.drums[1][12] = true;
        setInst('drums');
    </script>
</body>
</html>
