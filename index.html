<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Music Studio</title>
    <!-- Only essential external script - Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- FontAwesome with fallback -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" onerror="this.remove()">
    
    <style>
        /* CRITICAL: Base styles inline to prevent 404 issues */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #0a0a0a !important; /* Force dark background */
            color: #e5e5e5;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* If background image fails, solid color remains */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #0a0a0a 100%);
            z-index: -1;
        }

        /* Header */
        header {
            height: 60px;
            background: linear-gradient(180deg, #141414 0%, #111 100%);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #9333ea, #06b6d4);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(147,51,234,0.3);
        }

        .transport {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(0,0,0,0.4);
            padding: 6px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }

        button {
            cursor: pointer;
            border: none;
            outline: none;
            transition: all 0.2s;
        }

        .btn-play {
            width: 44px;
            height: 44px;
            background: #06b6d4;
            border-radius: 50%;
            color: #000;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(6,182,212,0.4);
        }

        .btn-play:hover { transform: scale(1.05); background: #22d3ee; }
        .btn-play:active { transform: scale(0.95); }
        .btn-play.playing { background: #22c55e; box-shadow: 0 0 20px rgba(34,197,94,0.4); }

        .btn-stop {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-stop:hover { background: rgba(255,255,255,0.2); }

        .time-display {
            font-family: 'Courier New', monospace;
            font-size: 20px;
            color: #06b6d4;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            text-shadow: 0 0 10px rgba(6,182,212,0.5);
        }

        /* Main Layout */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #111;
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #666;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .inst-btn {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #999;
            border-radius: 8px;
            margin-bottom: 8px;
            text-align: left;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .inst-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .inst-btn.active {
            background: rgba(6,182,212,0.15);
            border-color: rgba(6,182,212,0.4);
            color: #06b6d4;
        }

        .control-group {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
        }

        .slider-container {
            margin-bottom: 12px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #06b6d4;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(6,182,212,0.5);
        }

        /* Center Area */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0a0a0a;
            position: relative;
        }

        .timeline {
            height: 40px;
            background: #151515;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #06b6d4;
            box-shadow: 0 0 10px rgba(6,182,212,0.8);
            pointer-events: none;
            left: 0%;
            transition: left 0.1s;
        }

        .playhead::before {
            content: '';
            position: absolute;
            top: -6px;
            left: -5px;
            width: 12px;
            height: 12px;
            background: #06b6d4;
            transform: rotate(45deg);
        }

        .track-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-image: linear-gradient(to right, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 100%;
        }

        .track {
            height: 80px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        .track-header {
            width: 140px;
            background: rgba(0,0,0,0.3);
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 5;
        }

        .track-name {
            font-size: 12px;
            font-weight: 600;
            color: #ccc;
        }

        .track-controls {
            display: flex;
            gap: 6px;
        }

        .btn-mute {
            width: 24px;
            height: 24px;
            background: rgba(239,68,68,0.2);
            color: #ef4444;
            border-radius: 4px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(239,68,68,0.3);
        }

        .track-content {
            flex: 1;
            position: relative;
            padding: 10px;
        }

        .clip {
            position: absolute;
            height: 60px;
            background: linear-gradient(135deg, #06b6d4, #9333ea);
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            cursor: move;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Sequencer */
        .sequencer {
            height: 220px;
            background: #111;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }

        .seq-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .seq-title {
            font-size: 13px;
            font-weight: 600;
        }

        .seq-controls {
            display: flex;
            gap: 8px;
        }

        .btn-seq {
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #999;
            border-radius: 6px;
            font-size: 11px;
        }

        .btn-seq:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .seq-grid {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-x: auto;
        }

        .seq-row {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .seq-label {
            width: 60px;
            font-size: 11px;
            color: #666;
        }

        .step {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .step:hover { background: rgba(255,255,255,0.1); }
        .step.active { 
            background: #06b6d4; 
            box-shadow: 0 0 15px rgba(6,182,212,0.5);
            border-color: rgba(6,182,212,0.5);
        }
        .step.playing {
            transform: scale(1.2);
            border-color: white;
            z-index: 10;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 28px;
            width: 340px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.8);
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .ai-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #9333ea, #06b6d4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.95); }
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 6px;
            letter-spacing: 0.05em;
        }

        select {
            width: 100%;
            padding: 10px;
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            border-radius: 6px;
            font-size: 13px;
        }

        .btn-generate {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #9333ea, #06b6d4);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            margin-top: 8px;
        }

        .btn-generate:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; }

        .progress-container {
            margin-top: 16px;
            display: none;
        }

        .progress-bar {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #9333ea, #06b6d4);
            transition: width 0.3s;
        }

        .btn-action {
            padding: 8px 16px;
            background: rgba(147,51,234,0.2);
            border: 1px solid rgba(147,51,234,0.4);
            color: #a855f7;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-action:hover { background: rgba(147,51,234,0.3); }

        .meter {
            display: flex;
            gap: 4px;
            height: 80px;
            align-items: end;
            margin-top: 8px;
        }

        .meter-bar {
            flex: 1;
            background: #22c55e;
            border-radius: 2px;
            transition: height 0.05s;
            opacity: 0.8;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-music" style="color: white;"></i>
            </div>
            <div>
                <h1 style="font-size: 16px; font-weight: bold; margin: 0;">StudioAI</h1>
                <p style="font-size: 10px; color: #666; margin: 0;">v2.0 // Web Audio Engine</p>
            </div>
        </div>

        <div class="transport">
            <button class="btn-stop" id="stopBtn" title="Stop">
                <i class="fas fa-square"></i>
            </button>
            <button class="btn-play" id="playBtn" title="Play/Pause">
                <i class="fas fa-play" id="playIcon" style="margin-left: 2px;"></i>
            </button>
            <div style="width: 1px; height: 24px; background: rgba(255,255,255,0.1);"></div>
            <div class="time-display" id="timeDisplay">00:00</div>
            <div style="display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 10px; color: #666;">BPM</span>
                <input type="number" id="bpmInput" value="128" min="60" max="200" 
                       style="width: 50px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 4px; border-radius: 4px; text-align: center; font-size: 12px;">
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button onclick="exportAudio()" class="btn-action">
                <i class="fas fa-download"></i> Export
            </button>
            <button onclick="showModal()" style="padding: 8px 16px; background: linear-gradient(135deg, #9333ea, #06b6d4); border: none; color: white; border-radius: 6px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-wand-magic-sparkles"></i> Generate
            </button>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <div>
                <div class="section-title">Instruments</div>
                <button class="inst-btn active" onclick="setInstrument('drums')" id="btn-drums">
                    <i class="fas fa-drum"></i> Drum Machine
                </button>
                <button class="inst-btn" onclick="setInstrument('bass')" id="btn-bass">
                    <i class="fas fa-guitar"></i> Bass Synth
                </button>
                <button class="inst-btn" onclick="setInstrument('lead')" id="btn-lead">
                    <i class="fas fa-wave-square"></i> Lead Synth
                </button>
            </div>

            <div>
                <div class="section-title">Master Effects</div>
                <div class="control-group">
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Reverb</span>
                            <span id="revVal">30%</span>
                        </div>
                        <input type="range" min="0" max="100" value="30" oninput="setReverb(this.value)">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Volume</span>
                            <span id="volVal">80%</span>
                        </div>
                        <input type="range" min="0" max="100" value="80" oninput="setVolume(this.value)">
                    </div>
                </div>
                
                <div class="control-group" style="margin-top: 12px;">
                    <div class="section-title" style="margin-bottom: 8px;">Master Meter</div>
                    <div class="meter" id="meters">
                        <div class="meter-bar" style="height: 20%;"></div>
                        <div class="meter-bar" style="height: 35%;"></div>
                        <div class="meter-bar" style="height: 28%;"></div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="workspace">
            <div class="timeline">
                <div class="playhead" id="playhead"></div>
            </div>

            <div class="track-area">
                <div class="track">
                    <div class="track-header">
                        <div class="track-name">Kick Drum</div>
                        <div class="track-controls">
                            <button class="btn-mute">M</button>
                        </div>
                    </div>
                    <div class="track-content">
                        <div class="clip" style="left: 20px; width: 150px;" onmousedown="startDrag(event, this)">
                            <i class="fas fa-drum" style="margin-right: 8px;"></i> Pattern A
                        </div>
                    </div>
                </div>

                <div class="track">
                    <div class="track-header">
                        <div class="track-name">Bass Line</div>
                        <div class="track-controls">
                            <button class="btn-mute">M</button>
                        </div>
                    </div>
                    <div class="track-content" id="track-bass"></div>
                </div>

                <div class="track">
                    <div class="track-header">
                        <div class="track-name">Lead Synth</div>
                        <div class="track-controls">
                            <button class="btn-mute">M</button>
                        </div>
                    </div>
                    <div class="track-content"></div>
                </div>
            </div>

            <div class="sequencer">
                <div class="seq-header">
                    <div class="seq-title">Step Sequencer</div>
                    <div class="seq-controls">
                        <button class="btn-seq" onclick="clearPattern()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                        <button class="btn-seq" onclick="randomPattern()">
                            <i class="fas fa-random"></i> Random
                        </button>
                    </div>
                </div>
                <div class="seq-grid" id="sequencer">
                    <!-- Generated by JS -->
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="aiModal" onclick="if(event.target===this)hideModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div class="ai-icon">
                    <i class="fas fa-robot" style="color: white; font-size: 20px;"></i>
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 18px;">AI Composer</h3>
                    <p style="margin: 0; font-size: 11px; color: #666;">Neural Pattern Generation</p>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Genre Style</label>
                <select id="aiGenre">
                    <option value="techno">Techno</option>
                    <option value="house">House</option>
                    <option value="hiphop">Hip Hop</option>
                    <option value="trap">Trap</option>
                    <option value="ambient">Ambient</option>
                </select>
            </div>

            <button class="btn-generate" id="genBtn" onclick="generate()">
                Generate Pattern
            </button>

            <div class="progress-container" id="progressDiv">
                <div class="progress-bar">
                    <div class="progress-fill" id="progFill"></div>
                </div>
                <div style="text-align: center; font-size: 11px; color: #666; margin-top: 8px;" id="progText">
                    Initializing...
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let isPlaying = false;
        let currentStep = 0;
        let currentInstrument = 'drums';
        let audioCtx = null;
        let instruments = {};
        let patterns = {
            drums: [[false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false],
                   [false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false],
                   [false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false]],
            bass: [[false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false],
                  [false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false],
                  [false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false]],
            lead: [[false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false],
                  [false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false],
                  [false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false]]
        };

        // Initialize audio engine
        async function initAudio() {
            await Tone.start();
            audioCtx = Tone.context;
            
            // Create instruments
            instruments.kick = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 10,
                oscillator: { type: "sine" },
                envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
            }).toDestination();
            
            instruments.snare = new Tone.NoiseSynth({
                noise: { type: 'white' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0 }
            }).toDestination();
            
            instruments.hihat = new Tone.MetalSynth({
                frequency: 200,
                envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
                harmonicity: 5.1,
                modulationIndex: 32,
                resonance: 4000,
                octaves: 1.5
            }).toDestination();
            instruments.hihat.volume.value = -10;
            
            instruments.bass = new Tone.MonoSynth({
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.1, decay: 0.3, sustain: 0.2, release: 2 },
                filterEnvelope: { attack: 0.001, decay: 0.1, sustain: 0.5, baseFrequency: 200, octaves: 2.6 }
            }).toDestination();
            
            instruments.lead = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "fatsawtooth", count: 3, spread: 30 },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 1 }
            }).toDestination();
            
            // Effects
            instruments.reverb = new Tone.Reverb({ decay: 3, wet: 0.3 }).toDestination();
            instruments.kick.connect(instruments.reverb);
            instruments.bass.connect(instruments.reverb);
            
            // Sequencer loop
            Tone.Transport.scheduleRepeat((time) => {
                step(time);
            }, "16n");
            
            Tone.Transport.bpm.value = 128;
            
            // Default pattern
            patterns.drums[0][0] = true;
            patterns.drums[0][4] = true;
            patterns.drums[0][8] = true;
            patterns.drums[0][12] = true;
            patterns.drums[1][4] = true;
            patterns.drums[1][12] = true;
            patterns.drums[2][2] = true;
            patterns.drums[2][6] = true;
            patterns.drums[2][10] = true;
            patterns.drums[2][14] = true;
            
            renderSequencer();
            animateMeters();
        }

        function step(time) {
            currentStep = (currentStep + 1) % 16;
            
            // Move playhead
            document.getElementById('playhead').style.left = (currentStep / 16 * 100) + '%';
            document.getElementById('timeDisplay').textContent = 
                '00:' + (currentStep < 10 ? '0'+currentStep : currentStep);
            
            // Play sounds
            if(currentInstrument === 'drums') {
                if(patterns.drums[0][currentStep]) instruments.kick.triggerAttackRelease("C1", "8n", time);
                if(patterns.drums[1][currentStep]) instruments.snare.triggerAttackRelease("8n", time);
                if(patterns.drums[2][currentStep]) instruments.hihat.triggerAttackRelease("32n", time, 0.3);
            } else if(currentInstrument === 'bass') {
                if(patterns.bass[0][currentStep]) instruments.bass.triggerAttackRelease("C2", "16n", time);
                if(patterns.bass[1][currentStep]) instruments.bass.triggerAttackRelease("E2", "16n", time);
                if(patterns.bass[2][currentStep]) instruments.bass.triggerAttackRelease("G2", "16n", time);
            }
            
            // Visual feedback
            const steps = document.querySelectorAll('.step');
            steps.forEach((el, idx) => {
                const stepIndex = idx % 16;
                const row = Math.floor(idx / 16);
                if(stepIndex === currentStep) {
                    el.style.borderColor = 'white';
                    el.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        el.style.borderColor = '';
                        el.style.transform = '';
                    }, 100);
                }
            });
        }

        // Transport controls
        document.getElementById('playBtn').onclick = async function() {
            if(!instruments.kick) await initAudio();
            
            if(isPlaying) {
                Tone.Transport.pause();
                isPlaying = false;
                this.classList.remove('playing');
                document.getElementById('playIcon').className = 'fas fa-play';
            } else {
                Tone.Transport.start();
                isPlaying = true;
                this.classList.add('playing');
                document.getElementById('playIcon').className = 'fas fa-pause';
            }
        };

        document.getElementById('stopBtn').onclick = function() {
            Tone.Transport.stop();
            currentStep = 0;
            isPlaying = false;
            document.getElementById('playhead').style.left = '0%';
            document.getElementById('playBtn').classList.remove('playing');
            document.getElementById('playIcon').className = 'fas fa-play';
        };

        document.getElementById('bpmInput').onchange = function() {
            Tone.Transport.bpm.value = this.value;
        };

        // Sequencer
        function renderSequencer() {
            const container = document.getElementById('sequencer');
            container.innerHTML = '';
            
            const labels = currentInstrument === 'drums' ? ['Kick', 'Snare', 'Hi-Hat'] : 
                          currentInstrument === 'bass' ? ['C Root', 'E Third', 'G Fifth'] : 
                          ['Note 1', 'Note 2', 'Note 3'];
            
            for(let row=0; row<3; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'seq-row';
                
                const label = document.createElement('div');
                label.className = 'seq-label';
                label.textContent = labels[row];
                rowDiv.appendChild(label);
                
                for(let i=0; i<16; i++) {
                    const step = document.createElement('div');
                    step.className = 'step';
                    if(patterns[currentInstrument][row][i]) step.classList.add('active');
                    step.onclick = () => toggleStep(row, i);
                    rowDiv.appendChild(step);
                }
                container.appendChild(rowDiv);
            }
        }

        function toggleStep(row, step) {
            patterns[currentInstrument][row][step] = !patterns[currentInstrument][row][step];
            renderSequencer();
        }

        function setInstrument(inst) {
            currentInstrument = inst;
            document.querySelectorAll('.inst-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-'+inst).classList.add('active');
            renderSequencer();
        }

        function clearPattern() {
            for(let i=0; i<3; i++) {
                for(let j=0; j<16; j++) patterns[currentInstrument][i][j] = false;
            }
            renderSequencer();
        }

        function randomPattern() {
            for(let i=0; i<3; i++) {
                for(let j=0; j<16; j++) patterns[currentInstrument][i][j] = Math.random() > 0.7;
            }
            renderSequencer();
        }

        // AI Modal
        function showModal() { document.getElementById('aiModal').classList.add('show'); }
        function hideModal() { document.getElementById('aiModal').classList.remove('show'); }

        function generate() {
            const btn = document.getElementById('genBtn');
            const prog = document.getElementById('progressDiv');
            const fill = document.getElementById('progFill');
            const text = document.getElementById('progText');
            const genre = document.getElementById('aiGenre').value;
            
            btn.disabled = true;
            prog.style.display = 'block';
            
            const steps = ['Loading weights...', 'Analyzing genre...', 'Synthesizing...', 'Finalizing...'];
            let i = 0;
            
            const interval = setInterval(() => {
                fill.style.width = ((i+1)/4*100) + '%';
                text.textContent = steps[i];
                i++;
                if(i >= 4) {
                    clearInterval(interval);
                    setTimeout(() => {
                        applyGeneratedPattern(genre);
                        hideModal();
                        btn.disabled = false;
                        prog.style.display = 'none';
                        fill.style.width = '0%';
                    }, 500);
                }
            }, 300);
        }

        function applyGeneratedPattern(genre) {
            clearPattern();
            if(genre === 'techno') {
                for(let i=0; i<16; i++) {
                    if(i%4===0) patterns.drums[0][i] = true;
                    if(i%8===4) patterns.drums[1][i] = true;
                    if(i%2===0) patterns.drums[2][i] = true;
                }
            } else if(genre === 'hiphop') {
                [0,4,8,12].forEach(i => patterns.drums[0][i] = true);
                [4,12].forEach(i => patterns.drums[1][i] = true);
            } else {
                randomPattern();
            }
            if(currentInstrument !== 'drums') setInstrument('drums');
            else renderSequencer();
        }

        // Effects
        function setReverb(val) {
            if(instruments.reverb) instruments.reverb.wet.value = val/100;
            document.getElementById('revVal').textContent = val + '%';
        }

        function setVolume(val) {
            if(Tone.Destination) Tone.Destination.volume.value = (val/100)*20 - 20;
            document.getElementById('volVal').textContent = val + '%';
        }

        // Meters
        function animateMeters() {
            const bars = document.querySelectorAll('.meter-bar');
            bars.forEach(bar => {
                const h = Math.random() * 100;
                bar.style.height = h + '%';
                bar.style.background = h > 80 ? '#ef4444' : h > 50 ? '#eab308' : '#22c55e';
            });
            if(isPlaying) requestAnimationFrame(animateMeters);
            else setTimeout(animateMeters, 50);
        }

        // Export (simulated since we can't easily record without CORS issues on GH pages)
        function exportAudio() {
            alert('Export feature requires backend setup.\n\nIn a real app, this would render the mix to WAV.');
        }

        // Drag and drop
        let draggedEl = null;
        let offset = {x:0,y:0};

        function startDrag(e, el) {
            draggedEl = el;
            offset.x = e.clientX - el.offsetLeft;
            offset.y = e.clientY - el.offsetTop;
            el.style.zIndex = 1000;
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function onDrag(e) {
            if(!draggedEl) return;
            draggedEl.style.left = (e.clientX - offset.x) + 'px';
        }

        function stopDrag() {
            if(draggedEl) draggedEl.style.zIndex = '';
            draggedEl = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
        }

        // Keyboard shortcut
        document.onkeydown = (e) => {
            if(e.code === 'Space') {
                e.preventDefault();
                document.getElementById('playBtn').click();
            }
        };
    </script>
</body>
</html>
